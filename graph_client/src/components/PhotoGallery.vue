<template>
  <div class="photo-gallery">
    <!-- PCÁ´ØÂ∏ÉÂ±Ä -->
    <template v-if="!isMobile">
      <div class="gallery-header">
        <div class="gallery-header-content">
          <div class="header-left">
            <h2>{{ pageTitle }}</h2>
            <span class="photo-count" v-if="allPhotosData.length > 0">{{ allPhotosData.length }}Âº†ÁÖßÁâá</span>
          </div>
          <div class="header-right">
            <!-- ÈùûÊúÄËøë‰∏ä‰º†È°µÈù¢ÊòæÁ§∫Êéß‰ª∂ -->
            <template v-if="!isRecentPage">
              <div class="view-mode">
                <button
                    :class="{ active: viewMode === 'grid' }"
                    @click="viewMode = 'grid'"
                    title="ÁΩëÊ†ºËßÜÂõæ"
                >
                  <i class="icon">‚ñ§</i>
                </button>
                <button
                    :class="{ active: viewMode === 'list' }"
                    @click="viewMode = 'list'"
                    title="ÂàóË°®ËßÜÂõæ"
                >
                  <i class="icon">‚ò∞</i>
                </button>
              </div>
              <div class="sort-by">
                <select v-model="sortOrder">
                  <option value="time-desc">Êó∂Èó¥ÈôçÂ∫è</option>
                  <option value="time-asc">Êó∂Èó¥ÂçáÂ∫è</option>
                </select>
              </div>
            </template>
            <!-- ÊâÄÊúâÈ°µÈù¢ÈÉΩÊòæÁ§∫ÊêúÁ¥¢Ê°Ü -->
            <div class="search-box">
              <input
                  type="text"
                  v-model="searchKeyword"
                  placeholder="ÊêúÁ¥¢ÁÖßÁâá..."
                  @keyup.enter="searchPhotos"
              />
              <button class="search-btn" @click="searchPhotos" title="ÊêúÁ¥¢">
                <i class="icon">üîç</i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="gallery-content">
        <!-- ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫ -->
        <div v-if="isSearching" class="search-result-info">
          ÊêúÁ¥¢ÁªìÊûúÔºöÊâæÂà∞ {{ filteredPhotos.length }} Âº†‰∏é"{{ searchKeyword }}"Áõ∏ÂÖ≥ÁöÑÁÖßÁâá
          <button class="clear-search" @click="clearSearch">Ê∏ÖÈô§ÊêúÁ¥¢</button>
        </div>

        <!-- ÊêúÁ¥¢ÁªìÊûúÂ±ïÁ§∫ -->
        <div v-if="isSearching" class="photo-grid-pc grid">
          <div v-for="photo in filteredPhotos" :key="photo.id" class="photo-item">
            <div class="photo-wrapper">
              <img :src="getPhotoUrl(photo)" :alt="photo.text">
              <div class="photo-hover-info">
                <div class="hover-top">
                  <input
                      type="checkbox"
                      class="select-photo"
                      v-model="selectedPhotos"
                      :value="photo.id"
                  >
                  <span class="photo-date">{{ formatDate(photo.time) }}</span>
                </div>
                <div class="hover-bottom">
                  <span class="photo-description">{{ photo.text }}</span>
                  <div class="photo-actions">
                    <!-- ÂõûÊî∂Á´ô‰∏≠ÊòæÁ§∫ÊÅ¢Â§çÊåâÈíÆÔºåÂÖ∂‰ªñÈ°µÈù¢ÊòæÁ§∫ÁßªÂä®Âà∞Áõ∏ÂÜåÊåâÈíÆ -->
                    <template v-if="filter === 'trash'">
                      <button class="action-btn" @click="restorePhoto(photo.id)">
                        <i class="icon">‚Ü©Ô∏è</i>
                      </button>
                    </template>
                    <template v-else>
                      <button class="action-btn" @click="moveToAlbum(photo)">
                        <i class="icon">üìÅ</i>
                      </button>
                    </template>
                    <button class="action-btn" @click="deletePhoto(photo.id)">
                      <i class="icon">{{ filter === 'trash' ? '‚ùå' : 'üóëÔ∏è' }}</i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ÈùûÊêúÁ¥¢Áä∂ÊÄÅ‰∏ãÁöÑÂÜÖÂÆπ -->
        <template v-else>
          <!-- ÊúÄËøë‰∏ä‰º†È°µÈù¢ÁöÑÁâπÊÆäÂ∏ÉÂ±Ä -->
          <div v-if="isRecentPage" class="recent-photos-grid">
            <div v-for="photo in recentPhotos" :key="photo.id" class="photo-item">
              <div class="photo-wrapper">
                <img :src="getPhotoUrl(photo)" :alt="photo.text">
                <div class="photo-hover-info">
                  <div class="hover-top">
                    <input
                        type="checkbox"
                        class="select-photo"
                        v-model="selectedPhotos"
                        :value="photo.id"
                    >
                  </div>
                  <div class="hover-bottom">
                    <span class="photo-description">{{ photo.text }}</span>
                    <div class="photo-actions">
                      <button class="action-btn" @click="moveToAlbum(photo)">
                        <i class="icon">üìÅ</i>
                      </button>
                      <button class="action-btn" @click="deletePhoto(photo.id)">
                        <i class="icon">üóëÔ∏è</i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ÂÖ∂‰ªñÈ°µÈù¢‰øùÊåÅÂéüÊúâÂàÜÁªÑÂ∏ÉÂ±Ä -->
          <template v-else>
            <div v-for="group in groupedPhotos" :key="group.date" class="photo-group">
              <div class="time-divider">{{ group.date }}</div>
              <div :class="['photo-grid-pc', viewMode]">
                <div v-for="photo in group.photos" :key="photo.id" class="photo-item">
                  <div class="photo-wrapper">
                    <img :src="getPhotoUrl(photo)" :alt="photo.text">
                    <div class="photo-hover-info">
                      <div class="hover-top">
                        <input
                            type="checkbox"
                            class="select-photo"
                            v-model="selectedPhotos"
                            :value="photo.id"
                        >
                        <span class="photo-date">{{ formatDate(photo.time) }}</span>
                      </div>
                      <div class="hover-bottom">
                        <span class="photo-description">{{ photo.text }}</span>
                        <div class="photo-actions">
                          <!-- Ê†πÊçÆÂΩìÂâçËøáÊª§Êù°‰ª∂ÊòæÁ§∫‰∏çÂêåÁöÑÊìç‰ΩúÊåâÈíÆ -->
                          <template v-if="filter === 'trash'">
                            <!-- ÂõûÊî∂Á´ô‰∏≠ÊòæÁ§∫ÊÅ¢Â§çÊåâÈíÆ -->
                            <button class="action-btn restore-btn" @click="restorePhoto(photo.id)" title="ÊÅ¢Â§çÁÖßÁâá">
                              <i class="icon">‚Ü©Ô∏è</i>
                            </button>
                            <!-- ÂõûÊî∂Á´ô‰∏≠ÊòæÁ§∫Ê∞∏‰πÖÂà†Èô§ÊåâÈíÆ -->
                            <button class="action-btn delete-btn" @click="deletePhoto(photo.id)" title="Ê∞∏‰πÖÂà†Èô§">
                              <i class="icon">‚ùå</i>
                            </button>
                          </template>
                          <template v-else>
                            <!-- Ê≠£Â∏∏Áä∂ÊÄÅÊòæÁ§∫ÁßªÂä®Âà∞Áõ∏ÂÜåÊåâÈíÆ -->
                            <button class="action-btn" @click="moveToAlbum(photo)" title="ÁßªÂä®Âà∞Áõ∏ÂÜå">
                              <i class="icon">üìÅ</i>
                            </button>
                            <!-- Ê≠£Â∏∏Áä∂ÊÄÅÊòæÁ§∫ÁßªÂà∞ÂõûÊî∂Á´ôÊåâÈíÆ -->
                            <button class="action-btn" @click="deletePhoto(photo.id)" title="ÁßªÂà∞ÂõûÊî∂Á´ô">
                              <i class="icon">üóëÔ∏è</i>
                            </button>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </template>
      </div>
    </template>

    <!-- ÁßªÂä®Á´ØÂ∏ÉÂ±Ä -->
    <template v-else>
      <div class="mobile-header">
        <h2>{{ pageTitle }}</h2>
        <button class="upload-btn" @click="triggerUpload">
          <i class="icon">+</i>
        </button>
      </div>
      <div class="photo-grid-mobile">
        <div v-for="photo in sortedPhotos" :key="photo.id" class="photo-item-mobile">
          <img :src="getPhotoUrl(photo)" :alt="photo.text">
          <div class="photo-info-mobile">
            <span class="photo-description">{{ photo.text }}</span>
            <span class="photo-date">{{ formatDate(photo.time) }}</span>
          </div>
        </div>
      </div>
    </template>

    <!-- ÁßªÂä®Âà∞Áõ∏ÂÜåÁöÑÂºπÁ™ó -->
    <div v-if="showMoveDialog" class="move-dialog">
      <div class="dialog-content">
        <h3>ÁßªÂä®Âà∞Áõ∏ÂÜå</h3>
        <div v-if="albumsList.length > 0" class="album-list">
          <div
              v-for="album in albumsList"
              :key="album.id"
              class="album-option"
              @click="confirmMoveToAlbum(album.id)"
          >
            {{ album.name }}
          </div>
        </div>
        <div v-else class="no-albums">
          <p>ÊÇ®ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜå</p>
          <p class="hint">ÂÖàÂàõÂª∫‰∏Ä‰∏™Áõ∏ÂÜåÔºåÁÑ∂ÂêéÂÜçÁßªÂä®ÁÖßÁâá</p>
        </div>
        <div class="dialog-actions">
          <button class="cancel-btn" @click="showMoveDialog = false">ÂèñÊ∂à</button>
        </div>
      </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂‰∏ä‰º†ËæìÂÖ•Ê°Ü -->
    <input
        type="file"
        ref="fileInput"
        style="display: none"
        accept="image/*"
        multiple
        @change="handleFileUpload"
    >
  </div>
</template>

<script>
import {useDevice} from '../composables/useDevice'
import {usePhotoStore} from '../composables/usePhotoStore'
import {ref, computed, watch} from 'vue'
import {useRoute} from 'vue-router'

// APIÂü∫Á°ÄURL
const API_BASE_URL = 'http://114.215.184.67:5000/api'

export default {
  name: 'PhotoGallery',
  props: {
    albumId: {
      type: [String, Number],
      default: null
    },
    filter: {
      type: String,
      default: null
    }
  },
  setup(props) {
    const {isMobile} = useDevice()
    const route = useRoute()
    const store = usePhotoStore()

    // Â∞ÜpropsÁöÑfilterËß£ÊûÑÂá∫Êù•ÔºåÊñπ‰æøÂú®Ê®°Êùø‰∏≠‰ΩøÁî®
    const filter = computed(() => props.filter)

    const viewMode = ref('grid')
    const sortOrder = ref('time-desc')
    const selectedPhotos = ref([])
    const showMoveDialog = ref(false)
    const photoToMove = ref(null)
    const fileInput = ref(null)

    // Ëé∑ÂèñÂΩìÂâçÁõ∏ÂÜåIDÔºàÂ¶ÇÊûúÊúâÔºâ
    const currentAlbumId = computed(() => {
      return props.albumId ? parseInt(props.albumId) : null
    })

    // Ëé∑ÂèñÂΩìÂâçÁõ∏ÂÜå‰ø°ÊÅØ
    const currentAlbum = computed(() => {
      return currentAlbumId.value ? store.getAlbumById(currentAlbumId.value) : null
    })

    // È°µÈù¢Ê†áÈ¢ò
    const pageTitle = computed(() => {
      if (currentAlbum.value) return currentAlbum.value.name
      if (props.filter === 'recent') return 'ÊúÄËøë‰∏ä‰º†'
      if (props.filter === 'trash') return 'ÂõûÊî∂Á´ô'
      return 'ÂÖ®ÈÉ®ÁÖßÁâá'
    })

    // Áõ¥Êé•Ëé∑ÂèñÊâÄÊúâÁÖßÁâáÔºåÁî®‰∫éÊòæÁ§∫
    const allPhotosData = ref([]);

    // Âä†ËΩΩÁÖßÁâá
    const loadPhotos = async () => {
      console.log('ÂºÄÂßãÂä†ËΩΩÁÖßÁâá');
      allPhotosData.value = await displayPhotos();
      console.log('ÁÖßÁâáÂä†ËΩΩÂÆåÊàêÔºåÊï∞Èáè:', allPhotosData.value.length);
    }

    // Ê†πÊçÆÂΩìÂâçËßÜÂõæÊòæÁ§∫ÁÖßÁâá
    const displayPhotos = async () => {
      console.log('displayPhotos called, filter:', props.filter, 'currentAlbumId:', currentAlbumId.value);

      if (props.filter === 'trash') {
        console.log('Ëé∑ÂèñÂõûÊî∂Á´ôÁÖßÁâá');
        return await store.getTrashPhotos();
      } else if (props.filter === 'recent') {
        console.log('Ëé∑ÂèñÊúÄËøëÁÖßÁâá');
        return await store.getRecentPhotos();
      } else if (currentAlbumId.value) {
        console.log('Ëé∑ÂèñÁõ∏ÂÜåÁÖßÁâáÔºåÁõ∏ÂÜåID:', currentAlbumId.value);
        return await store.getPhotosByAlbum(currentAlbumId.value);
      } else {
        console.log('Ëé∑ÂèñÊâÄÊúâÁÖßÁâá');
        return await store.getAllPhotos();
      }
    }

    // ÁõëÂê¨ËßÜÂõæÂèòÂåñ
    watch([() => props.filter, currentAlbumId], async () => {
      console.log('ËßÜÂõæÂèòÂåñÔºåÈáçÊñ∞Âä†ËΩΩÁÖßÁâá');
      await loadPhotos();
    }, {immediate: true})

    // ‰∏ä‰º†ÁÖßÁâá
    const handleUpload = async (files) => {
      console.log('ÂºÄÂßã‰∏ä‰º†ÁÖßÁâáÔºåÊñá‰ª∂Êï∞Èáè:', files.length);

      for (const file of files) {
        const formData = new FormData()
        formData.append('photo', file)
        formData.append('user_id', store.getUserId())

        const result = await store.addPhoto(formData)
        if (result.success) {
          console.log('ÁÖßÁâá‰∏ä‰º†ÊàêÂäü:', result.photoId);
          // Âè™Ëé∑ÂèñÊñ∞‰∏ä‰º†ÁöÑÁÖßÁâá
          const newPhoto = await store.getPhotoById(result.photoId);
          if (newPhoto) {
            allPhotosData.value = [newPhoto, ...allPhotosData.value];
          }
        } else {
          console.error('ÁÖßÁâá‰∏ä‰º†Â§±Ë¥•:', result.message);
        }
      }
    }

    // ÊåâÊó•ÊúüÂàÜÁªÑÁöÑÁÖßÁâá
    const groupedPhotos = computed(() => {
      if (!allPhotosData.value || !Array.isArray(allPhotosData.value)) {
        console.log("groupedPhotos: ÁÖßÁâáÊï∞ÊçÆÊó†Êïà", allPhotosData.value);
        return [];
      }

      console.log("groupedPhotos: Â§ÑÁêÜÁÖßÁâáÊï∞ÊçÆÔºåÊï∞Èáè:", allPhotosData.value.length);
      console.log("ÁÖßÁâáÊï∞ÊçÆÁ§∫‰æã:", allPhotosData.value.length > 0 ? allPhotosData.value[0] : null);

      // È¶ñÂÖàÊåâÊó∂Èó¥ÊéíÂ∫è
      const sorted = [...allPhotosData.value].sort((a, b) => {
        switch (sortOrder.value) {
          case 'time-desc':
            return new Date(b.time || 0) - new Date(a.time || 0);
          case 'time-asc':
            return new Date(a.time || 0) - new Date(b.time || 0);
          default:
            return 0;
        }
      });

      // ÊåâÊó•ÊúüÂàÜÁªÑ
      const groups = {};
      sorted.forEach(photo => {
        // Á°Æ‰øùÊó•ÊúüÊ≠£Á°ÆËß£Êûê
        const photoDate = photo.time ? new Date(photo.time) : new Date();
        // ‰ΩøÁî®Âπ¥ÊúàÊó•Ê†ºÂºè
        const dateKey = formatDate(photoDate);
        if (!groups[dateKey]) {
          groups[dateKey] = [];
        }
        groups[dateKey].push(photo);
      });

      // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºè
      const result = Object.entries(groups).map(([date, photos]) => ({
        date,
        photos
      }));

      console.log("groupedPhotos: ÂàÜÁªÑÁªìÊûúÔºåÁªÑÊï∞:", result.length);
      return result;
    })

    // Ëé∑ÂèñÊâÄÊúâÁõ∏ÂÜåÂàóË°®
    const albums = computed(() => store.getAllAlbums())

    // Âà§Êñ≠ÊòØÂê¶‰∏∫ÊúÄËøë‰∏ä‰º†È°µÈù¢
    const isRecentPage = computed(() => props.filter === 'recent')

    // Ëé∑ÂèñÊúÄËøë‰∏ÄÂë®ÁöÑÁÖßÁâáÔºàÊåâ‰∏ä‰º†Êó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºâ
    const recentPhotos = computed(() => {
      if (!allPhotosData.value || !Array.isArray(allPhotosData.value)) return [];

      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

      return allPhotosData.value
          .filter(photo => {
            // Á°Æ‰øùÊó•ÊúüÊ≠£Á°ÆËß£Êûê
            const photoDate = photo.time ? new Date(photo.time) : new Date();
            return photoDate >= oneWeekAgo;
          })
          .sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
    })

    // ÁßªÂä®Á´ØÊéíÂ∫èÂêéÁöÑÁÖßÁâá
    const sortedPhotos = computed(() => {
      if (!allPhotosData.value || !Array.isArray(allPhotosData.value)) return [];

      return [...allPhotosData.value].sort((a, b) => {
        switch (sortOrder.value) {
          case 'time-desc':
            return new Date(b.time || 0) - new Date(a.time || 0);
          case 'time-asc':
            return new Date(a.time || 0) - new Date(b.time || 0);
          default:
            return 0;
        }
      });
    })

    // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
    const handleFileUpload = async (event) => {
      console.log('Êñá‰ª∂‰∏ä‰º†ÂºÄÂßã');
      const files = event.target.files;
      if (!files.length) {
        console.log('Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂');
        return;
      }

      console.log(`ÈÄâÊã©‰∫Ü${files.length}‰∏™Êñá‰ª∂`);

      try {
        for (const file of Array.from(files)) {
          console.log(`Â§ÑÁêÜÊñá‰ª∂: ${file.name}, Â§ßÂ∞è: ${file.size}Â≠óËäÇ, Á±ªÂûã: ${file.type}`);

          // ÂàõÂª∫FormDataÂØπË±°
          const formData = new FormData();

          // Á°Æ‰øùÊ∑ªÂä†Êñá‰ª∂
          formData.append('photo', file);

          const userId = store.getUserId();
          console.log(`Áî®Êà∑ID: ${userId}`);
          formData.append('user_id', userId);

          if (currentAlbumId.value) {
            console.log(`Áõ∏ÂÜåID: ${currentAlbumId.value}`);
            formData.append('album_id', currentAlbumId.value);
          }

          formData.append('text', file.name);

          console.log('ÂºÄÂßã‰∏ä‰º†...');

          // ‰∏ä‰º†ÁÖßÁâá - ‰ΩøÁî®fetchÁõ¥Êé•‰∏ä‰º†
          try {
            const response = await fetch(`${API_BASE_URL}/photos/upload`, {
              method: 'POST',
              body: formData
            });

            console.log('‰∏ä‰º†ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);

            if (response.ok) {
              const data = await response.json();
              console.log('‰∏ä‰º†ÂìçÂ∫îÊï∞ÊçÆ:', data);

              if (data.success) {
                console.log('‰∏ä‰º†ÊàêÂäü');
              } else {
                alert(`‰∏ä‰º†Â§±Ë¥•: ${data.message || 'Êú™Áü•ÈîôËØØ'}`);
              }
            } else {
              alert(`‰∏ä‰º†Â§±Ë¥•ÔºåÊúçÂä°Âô®ËøîÂõû: ${response.status}`);
            }
          } catch (uploadError) {
            console.error('‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Èîô:', uploadError);
            alert(`‰∏ä‰º†Â§±Ë¥•: ${uploadError.message || 'ÁΩëÁªúÈîôËØØ'}`);
          }
        }

        // Ê∏ÖÈô§input
        event.target.value = '';

        // Âà∑Êñ∞ÁÖßÁâáÂàóË°®
        console.log('Âà∑Êñ∞ÁÖßÁâáÂàóË°®');
        await loadPhotos();

      } catch (error) {
        console.error('Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Èîô:', error);
        alert(`‰∏ä‰º†Â§ÑÁêÜÂ§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
      }
    }

    // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
    const triggerUpload = () => {
      fileInput.value.click()
    }

    // Áõ∏ÂÜåÂàóË°®
    const albumsList = ref([])

    // ÁßªÂä®ÁÖßÁâáÂà∞Áõ∏ÂÜå
    const moveToAlbum = async (photo) => {
      photoToMove.value = photo
      // Âú®ÊòæÁ§∫ÂØπËØùÊ°ÜÂâçÂÖàÂä†ËΩΩÊúÄÊñ∞ÁöÑÁõ∏ÂÜåÂàóË°®
      try {
        albumsList.value = await store.getAllAlbums()
        console.log('Âä†ËΩΩÁõ∏ÂÜåÂàóË°®ÊàêÂäüÔºåÊï∞Èáè:', albumsList.value.length)
      } catch (error) {
        console.error('Âä†ËΩΩÁõ∏ÂÜåÂàóË°®Â§±Ë¥•:', error)
        albumsList.value = []
      }
      showMoveDialog.value = true
    }

    // Á°ÆËÆ§ÁßªÂä®Âà∞Áõ∏ÂÜå
    const confirmMoveToAlbum = (albumId) => {
      if (photoToMove.value) {
        store.movePhotoToAlbum(photoToMove.value.id, albumId)
        showMoveDialog.value = false
        photoToMove.value = null
      }
    }

    // Âà†Èô§ÁÖßÁâá
    const deletePhoto = (photoId) => {
      if (props.filter === 'trash') {
        // Âú®ÂõûÊî∂Á´ô‰∏≠ÔºåÊâßË°åÊ∞∏‰πÖÂà†Èô§
        if (confirm('Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
          store.permanentlyDelete(photoId).then(async (result) => {
            if (result.success) {
              // ÈáçÊñ∞Âä†ËΩΩÂõûÊî∂Á´ôÁÖßÁâá
              await loadPhotos();
            } else {
              alert('Âà†Èô§Â§±Ë¥•Ôºö' + result.message);
            }
          });
        }
      } else {
        // Âú®ÂÖ∂‰ªñÈ°µÈù¢ÔºåÁßªÂä®Âà∞ÂõûÊî∂Á´ô
        if (confirm('Á°ÆÂÆöË¶ÅÂ∞ÜËøôÂº†ÁÖßÁâáÁßªÂà∞ÂõûÊî∂Á´ôÂêóÔºü')) {
          store.moveToTrash(photoId).then(async (result) => {
            if (result.success) {
              // ÈáçÊñ∞Âä†ËΩΩÁÖßÁâáÂàóË°®
              await loadPhotos();
            } else {
              alert('ÁßªÂä®Âà∞ÂõûÊî∂Á´ôÂ§±Ë¥•Ôºö' + result.message);
            }
          });
        }
      }
    }

    // ÊÅ¢Â§çÁÖßÁâá
    const restorePhoto = (photoId) => {
      if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çËøôÂº†ÁÖßÁâáÂêóÔºü')) {
        store.restoreFromTrash(photoId).then(async (result) => {
          if (result.success) {
            // ÈáçÊñ∞Âä†ËΩΩÂõûÊî∂Á´ôÁÖßÁâá
            await loadPhotos();
          } else {
            alert('ÊÅ¢Â§çÂ§±Ë¥•Ôºö' + result.message);
          }
        });
      }
    }

    // ÊêúÁ¥¢Áõ∏ÂÖ≥
    const searchKeyword = ref('')
    const isSearching = ref(false)
    const searchResults = ref([]) // Â≠òÂÇ®ÊêúÁ¥¢ÁªìÊûú

    // Ëé∑ÂèñÂΩìÂâçËßÜÂõæÁ±ªÂûãÔºåÁî®‰∫éÊêúÁ¥¢
    const currentView = computed(() => {
      if (props.filter === 'trash') return 'trash'
      if (props.filter === 'recent') return 'recent'
      if (currentAlbumId.value) return 'album' // Áõ∏ÂÜåËßÜÂõæÁâπÊÆäÂ§ÑÁêÜ
      return 'all'
    })

    // ÊêúÁ¥¢ÁÖßÁâá
    const searchPhotos = async () => {
      if (!searchKeyword.value.trim()) return

      console.log(`ÊâßË°åÊêúÁ¥¢ÔºåÂÖ≥ÈîÆËØç: "${searchKeyword.value}", ÂΩìÂâçËßÜÂõæ: ${currentView.value}`);

      try {
        // Âú®Áõ∏ÂÜåËßÜÂõæÁâπÊÆäÂ§ÑÁêÜ
        if (currentView.value === 'album' && currentAlbumId.value) {
          // ÂÖàËé∑ÂèñÊâÄÊúâÁõ∏ÂÜåÁÖßÁâá
          const albumPhotos = await store.getPhotosByAlbum(currentAlbumId.value) || []
          // Êú¨Âú∞ËøáÊª§
          searchResults.value = albumPhotos.filter(photo =>
              (photo.text && photo.text.toLowerCase().includes(searchKeyword.value.toLowerCase())) ||
              (photo.time && new Date(photo.time).toLocaleDateString('zh-CN').includes(searchKeyword.value))
          )
        } else {
          // ÂÖ∂‰ªñËßÜÂõæ‰ΩøÁî®APIÊêúÁ¥¢
          searchResults.value = await store.searchPhotos(searchKeyword.value, currentView.value) || []
        }

        console.log(`ÊêúÁ¥¢ÂÆåÊàêÔºåÊâæÂà∞ ${searchResults.value.length} Âº†ÁÖßÁâá`);
        isSearching.value = true
      } catch (error) {
        console.error('ÊêúÁ¥¢Âá∫Èîô:', error)
        searchResults.value = []
        isSearching.value = true
      }
    }

    // Ê†πÊçÆÂÖ≥ÈîÆËØçËøáÊª§ÁÖßÁâáÔºà‰ΩøÁî®ÊêúÁ¥¢ÁªìÊûúÔºâ
    const filteredPhotos = computed(() => {
      return searchResults.value
    })

    // Ê∏ÖÈô§ÊêúÁ¥¢
    const clearSearch = () => {
      searchKeyword.value = ''
      isSearching.value = false
      searchResults.value = []
    }

    // Ëé∑ÂèñÂÆåÊï¥ÁöÑÂõæÁâáURL
    const getPhotoUrl = (photo) => {
      if (!photo || !photo.address) return '';

      // Â¶ÇÊûúÊòØÁªùÂØπURLÔºåÁõ¥Êé•ËøîÂõû
      if (photo.address.startsWith('http')) {
        return photo.address;
      }

      // Âê¶ÂàôÊûÑÂª∫ÂÆåÊï¥URL
      const fullUrl = `http://114.215.184.67:5000/${photo.address}`;
      console.log('Photo URL:', fullUrl);
      return fullUrl;
    }

    // Ëá™ÂÆö‰πâÊó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∞
    const formatDate = (date) => {
      if (!date) return '';

      // Á°Æ‰øùdateÊòØDateÂØπË±°
      const dateObj = date instanceof Date ? date : new Date(date);

      // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÊúâÊïà
      if (isNaN(dateObj.getTime())) return '';

      // Ê†ºÂºèÂåñ‰∏∫ YYYY-MM-DD
      const year = dateObj.getFullYear();
      // Êúà‰ªΩÈúÄË¶Å+1ÔºåÂõ†‰∏∫getMonth()ËøîÂõû0-11
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const day = String(dateObj.getDate()).padStart(2, '0');

      return `${year}-${month}-${day}`;
    }

    return {
      isMobile,
      viewMode,
      sortOrder,
      selectedPhotos,
      showMoveDialog,
      fileInput,
      currentAlbum,
      pageTitle,
      displayPhotos,
      groupedPhotos,
      albums,
      handleFileUpload,
      triggerUpload,
      moveToAlbum,
      confirmMoveToAlbum,
      deletePhoto,
      restorePhoto,
      formatDate,
      isRecentPage,
      recentPhotos,
      sortedPhotos,
      searchKeyword,
      isSearching,
      filteredPhotos,
      searchPhotos,
      clearSearch,
      getPhotoUrl,
      allPhotosData,
      filter,
      albumsList
    }
  }
}
</script>

<style scoped>
.photo-gallery {
  height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 0;
  margin: 0 20px; /* ÂáèÂ∞ëÂ∑¶Âè≥ËæπË∑ù */
  box-sizing: border-box;
  overflow: hidden;
}

.gallery-header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #fff;
  border-bottom: 1px solid #eee;
  padding: 1rem 0;
  flex-shrink: 0;
}

.gallery-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0;
  width: 100%;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  white-space: nowrap;
  min-width: 200px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
}

/* ÊêúÁ¥¢Ê°ÜÊ†∑Âºè */
.search-box {
  display: flex;
  align-items: center;
  min-width: 250px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 0.5rem 2.5rem 0.5rem 0.8rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s;
}

.search-box input:focus {
  border-color: #1890ff;
}

.search-btn {
  position: absolute;
  right: 0.5rem;
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
  padding: 0.3rem;
}

.search-btn:hover {
  color: #1890ff;
}

/* ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫Ê†∑Âºè */
.search-result-info {
  margin: 1rem 0;
  padding: 0.8rem;
  background: #f8f9fa;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.clear-search {
  background: none;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 0.3rem 0.8rem;
  cursor: pointer;
  color: #666;
  transition: all 0.2s;
}

.clear-search:hover {
  background: #f0f0f0;
  color: #333;
}

.gallery-content {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
  padding: 1rem 0;
  width: 100%;
}

/* ÈöêËóèWebkitÊµèËßàÂô®ÁöÑÊªöÂä®Êù° */
.gallery-content::-webkit-scrollbar {
  display: none;
}

.header-left h2 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 500;
}

.photo-count {
  color: #999;
  margin-left: 1rem;
}

.view-mode {
  display: flex;
  gap: 0.5rem;
}

.view-mode button {
  padding: 0.5rem;
  border: 1px solid #ddd;
  background: white;
  border-radius: 4px;
  cursor: pointer;
}

.view-mode button.active {
  background: #e6f3ff;
  border-color: #1890ff;
  color: #1890ff;
}

.sort-by select {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  color: #666;
}

.time-divider {
  width: 100%;
  padding: 0.8rem 0;
  color: #666;
  font-weight: 500;
  font-size: 1.1rem;
}

.photo-group {
  margin-bottom: 1.5rem;
}

.photo-grid-pc {
  display: grid;
  gap: 1rem;
  padding: 0.8rem 0;
  width: 100%;
}

.photo-grid-pc.grid {
  grid-template-columns: repeat(8, 1fr); /* Âõ∫ÂÆö8Âàó */
}

.photo-grid-pc.list {
  grid-template-columns: 1fr;
}

.photo-wrapper {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
  border-radius: 8px;
  background: #f5f5f5;
}

.photo-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-hover-info {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  color: white;
  opacity: 0;
  transition: opacity 0.2s;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 1rem;
}

.photo-wrapper:hover .photo-hover-info {
  opacity: 1;
}

.hover-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.hover-bottom {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.photo-actions {
  display: flex;
  gap: 0.5rem;
}

.action-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0.3rem;
  border-radius: 4px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.action-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.action-btn i {
  font-size: 1.2rem;
}

/* Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶Ë∞ÉÊï¥ÂàóÊï∞ */
@media (max-width: 2400px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(7, 1fr);
  }
}

@media (max-width: 2000px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(6, 1fr);
  }
}

@media (max-width: 1700px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(5, 1fr);
  }
}

@media (max-width: 1400px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 1100px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .photo-grid-pc.grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ÁßªÂä®Á´ØÊ†∑Âºè */
.mobile-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #eee;
  flex-shrink: 0;
}

.mobile-header h2 {
  margin: 0;
  font-size: 1.2rem;
}

.photo-grid-mobile {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.5rem;
  padding: 0.5rem;
}

.photo-grid-mobile::-webkit-scrollbar {
  display: none;
}

.photo-item-mobile {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  background: white;
}

.photo-item-mobile img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
}

.photo-info-mobile {
  padding: 0.8rem;
}

.photo-info-mobile .photo-description {
  display: block;
  font-size: 0.9rem;
  margin-bottom: 0.4rem;
}

.photo-info-mobile .photo-date {
  color: #666;
  font-size: 0.8rem;
}

/* ÁßªÂä®Âà∞Áõ∏ÂÜåÂºπÁ™óÊ†∑Âºè */
.move-dialog {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.dialog-content {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  min-width: 300px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.dialog-content h3 {
  margin: 0 0 1rem 0;
  font-size: 1.2rem;
  color: #333;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.8rem;
}

.album-list {
  max-height: 300px;
  overflow-y: auto;
  margin: 1rem 0;
}

.album-option {
  padding: 0.8rem 1rem;
  cursor: pointer;
  border-radius: 6px;
  margin-bottom: 0.5rem;
  transition: background-color 0.2s;
}

.album-option:hover {
  background-color: #f0f7ff;
}

.no-albums {
  text-align: center;
  padding: 2rem 0;
  color: #666;
}

.no-albums .hint {
  font-size: 0.9rem;
  color: #999;
  margin-top: 0.5rem;
}

.dialog-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.cancel-btn {
  padding: 0.6rem 1.2rem;
  background: #f5f5f5;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: #333;
}

.cancel-btn:hover {
  background: #e5e5e5;
}

.recent-photos-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 1rem;
  padding: 0.8rem 0;
  width: 100%;
}

/* ÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */
@media (max-width: 2400px) {
  .recent-photos-grid {
    grid-template-columns: repeat(7, 1fr);
  }
}

@media (max-width: 2000px) {
  .recent-photos-grid {
    grid-template-columns: repeat(6, 1fr);
  }
}

@media (max-width: 1700px) {
  .recent-photos-grid {
    grid-template-columns: repeat(5, 1fr);
  }
}

@media (max-width: 1400px) {
  .recent-photos-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 1100px) {
  .recent-photos-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .recent-photos-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Êñ∞Â¢ûÊåâÈíÆÊ†∑Âºè */
.restore-btn:hover {
  background-color: rgba(50, 205, 50, 0.3); /* ÊÅ¢Â§çÊåâÈíÆÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÁªøËâ≤ËÉåÊôØ */
}

.delete-btn:hover {
  background-color: rgba(255, 0, 0, 0.3); /* Ê∞∏‰πÖÂà†Èô§ÊåâÈíÆÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Á∫¢Ëâ≤ËÉåÊôØ */
}
</style> 